{% extends "base.html" %}

{% block title %}Dashboard - Spotify Playlist Generator{% endblock %}

{% block content %}
<div class="dashboard-container">
  <div class="row">
    <div class="col-lg-3">
      <!-- Sidebar -->
      <div class="dashboard-sidebar">
        <div class="user-profile text-center mb-4">
          <div class="avatar">
            <i class="bi bi-person-circle"></i>
          </div>
          <h5>{{ current_user.email }}</h5>
          {% if current_user.has_active_subscription %}
            <span class="badge bg-success">Active Subscription</span>
          {% else %}
            <span class="badge bg-warning">No Subscription</span>
          {% endif %}
        </div>
        
        <div class="sidebar-menu">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" href="{{ url_for('dashboard') }}">
                <i class="bi bi-speedometer2"></i> Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('create_playlist') }}">
                <i class="bi bi-music-note-list"></i> Create Playlist
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('auth.profile') }}">
                <i class="bi bi-gear"></i> Account Settings
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('auth.logout') }}">
                <i class="bi bi-box-arrow-right"></i> Logout
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    
    <div class="col-lg-9">
      <!-- Main Content -->
      <div class="dashboard-content">
        <!-- Alerts and Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}
        
        <!-- Welcome and Stats -->
        <div class="welcome-card mb-4">
          <div class="row align-items-center">
            <div class="col-md-7">
              <h2>Welcome back, {{ current_user.email.split('@')[0] }}!</h2>
              <p class="text-muted">Here's an overview of your activity</p>
              
              <div class="stats mt-4">
                <div class="row">
                  <div class="col-4">
                    <div class="stat-item">
                      <div class="stat-value">{{ playlists|length }}</div>
                      <div class="stat-label">Playlists</div>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="stat-item">
                      <div class="stat-value">{{ total_tracks }}</div>
                      <div class="stat-label">Tracks</div>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="stat-item">
                      <div class="stat-value">{{ genres|length }}</div>
                      <div class="stat-label">Genres</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-5 text-center">
              <div class="action-buttons">
                <a href="{{ url_for('create_playlist') }}" class="btn btn-success btn-lg mb-2 d-block" 
                   {% if not current_user.has_active_subscription or not spotify_connected %}disabled{% endif %}>
                  <i class="bi bi-plus-circle-fill me-2"></i> Create New Playlist
                </a>
                
                {% if spotify_connected %}
                  <a href="{{ url_for('view_spotify_profile') }}" class="btn btn-outline-success d-block">
                    <i class="bi bi-spotify me-2"></i> View Spotify Profile
                  </a>
                {% else %}
                  <a href="{{ url_for('connect_spotify') }}" class="btn btn-outline-danger d-block">
                    <i class="bi bi-spotify me-2"></i> Connect Spotify Account
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Subscription Card -->
        {% if not current_user.has_active_subscription %}
        <div class="subscription-alert mb-4">
          <div class="card border-warning">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-8">
                  <h4><i class="bi bi-exclamation-triangle-fill text-warning me-2"></i> Subscription Required</h4>
                  <p class="mb-0">You need an active subscription to create playlists. Enjoy unlimited playlists for just $3/month.</p>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                  <a href="{{ url_for('subscribe') }}" class="btn btn-warning">Subscribe Now</a>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
        <!-- Spotify Connection Card -->
        {% if not spotify_connected %}
        <div class="spotify-alert mb-4">
          <div class="card border-danger">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-8">
                  <h4><i class="bi bi-spotify text-danger me-2"></i> Connect Spotify</h4>
                  <p class="mb-0">You need to connect your Spotify account to create playlists.</p>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                  <a href="{{ url_for('connect_spotify') }}" class="btn btn-danger">Connect Now</a>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
        <!-- Recent Playlists -->
        <div class="recent-playlists mb-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Your Playlists</h3>
            <a href="{{ url_for('create_playlist') }}" class="btn btn-sm btn-success" 
               {% if not current_user.has_active_subscription or not spotify_connected %}disabled{% endif %}>
              <i class="bi bi-plus-lg"></i> New Playlist
            </a>
          </div>
          
          {% if playlists %}
            <div class="table-responsive">
              <table class="table table-hover playlist-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Genre</th>
                    <th>Tracks</th>
                    <th>Created</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for playlist in playlists %}
                  <tr>
                    <td>
                      <div class="playlist-name">{{ playlist.name }}</div>
                      {% if playlist.description %}
                        <small class="text-muted">{{ playlist.description|truncate(50) }}</small>
                      {% endif %}
                    </td>
                    <td>{{ playlist.genre }}</td>
                    <td>{{ playlist.track_count }}</td>
                    <td>{{ playlist.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>
                      {% if playlist.status == 'completed' %}
                        <span class="badge bg-success">Completed</span>
                      {% elif playlist.status == 'failed' %}
                        <span class="badge bg-danger">Failed</span>
                      {% elif playlist.status == 'running' %}
                        <span class="badge bg-primary">Running</span>
                      {% else %}
                        <span class="badge bg-secondary">Pending</span>
                      {% endif %}
                    </td>
                    <td>
                      <div class="btn-group">
                        <a href="{{ url_for('view_playlist', task_id=playlist.id) }}" class="btn btn-sm btn-outline-primary">
                          <i class="bi bi-eye"></i>
                        </a>
                        {% if playlist.status == 'completed' and playlist.playlist_url %}
                          <a href="{{ playlist.playlist_url }}" target="_blank" class="btn btn-sm btn-outline-success">
                            <i class="bi bi-spotify"></i>
                          </a>
                        {% endif %}
                        {% if playlist.status == 'failed' %}
                          <a href="{{ url_for('create_playlist', retry=playlist.id) }}" class="btn btn-sm btn-outline-warning">
                            <i class="bi bi-arrow-repeat"></i>
                          </a>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
            {% if playlists|length > 10 %}
              <div class="text-center mt-3">
                <a href="{{ url_for('all_playlists') }}" class="btn btn-outline-primary">View All Playlists</a>
              </div>
            {% endif %}
          {% else %}
            <div class="empty-state text-center py-5">
              <i class="bi bi-music-note-list display-1 text-muted"></i>
              <h4 class="mt-3">No Playlists Yet</h4>
              <p class="text-muted">Create your first playlist to get started</p>
              <a href="{{ url_for('create_playlist') }}" class="btn btn-success mt-3" 
                 {% if not current_user.has_active_subscription or not spotify_connected %}disabled{% endif %}>
                <i class="bi bi-plus-circle me-2"></i> Create Your First Playlist
              </a>
            </div>
          {% endif %}
        </div>
        
        <!-- Getting Started Card (for new users) -->
        {% if playlists|length < 3 %}
        <div class="getting-started mb-4">
          <div class="card">
            <div class="card-header bg-light">
              <h4 class="mb-0">
                <i class="bi bi-lightbulb-fill text-warning me-2"></i>
                Getting Started
              </h4>
            </div>
            <div class="card-body">
              <div class="steps">
                <div class="step {% if spotify_connected %}completed{% endif %}">
                  <div class="step-number">1</div>
                  <div class="step-content">
                    <h5>Connect Spotify</h5>
                    <p>Link your Spotify account to enable playlist creation</p>
                    {% if not spotify_connected %}
                      <a href="{{ url_for('connect_spotify') }}" class="btn btn-sm btn-outline-success">Connect Now</a>
                    {% else %}
                      <span class="badge bg-success">Completed</span>
                    {% endif %}
                  </div>
                </div>
                
                <div class="step {% if current_user.has_active_subscription %}completed{% endif %}">
                  <div class="step-number">2</div>
                  <div class="step-content">
                    <h5>Subscribe</h5>
                    <p>Activate your subscription to unlock unlimited playlist creation</p>
                    {% if not current_user.has_active_subscription %}
                      <a href="{{ url_for('subscribe') }}" class="btn btn-sm btn-outline-success">Subscribe</a>
                    {% else %}
                      <span class="badge bg-success">Completed</span>
                    {% endif %}
                  </div>
                </div>
                
                <div class="step {% if playlists|length > 0 %}completed{% endif %}">
                  <div class="step-number">3</div>
                  <div class="step-content">
                    <h5>Create Your First Playlist</h5>
                    <p>Generate a personalized playlist based on your preferences</p>
                    {% if playlists|length == 0 %}
                      <a href="{{ url_for('create_playlist') }}" class="btn btn-sm btn-outline-success" 
                         {% if not current_user.has_active_subscription or not spotify_connected %}disabled{% endif %}>
                        Create Now
                      </a>
                    {% else %}
                      <span class="badge bg-success">Completed</span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

<!-- explainer: Enhanced the dashboard with a comprehensive user experience featuring a sidebar navigation, user statistics, subscription status indicators, action buttons, playlist table with sorting and filtering capabilities, and a getting started guide for new users. Conditional elements show or hide based on subscription status and Spotify connection. -->