{% extends "base.html" %}

{% block title %}Subscription - Spotify Playlist Generator{% endblock %}

{% block content %}
<div class="subscription-container">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <h1 class="text-center mb-4">Subscription</h1>
      
      <div class="subscription-box">
        <div class="row">
          <div class="col-lg-6">
            <div class="subscription-details">
              <div class="subscription-header">
                <h2>Premium Plan</h2>
                <div class="price">
                  <span class="currency">$</span>
                  <span class="amount">3</span>
                  <span class="period">/month</span>
                </div>
              </div>
              
              <div class="features">
                <div class="feature-item">
                  <i class="bi bi-check-circle-fill text-success"></i>
                  <span>Create unlimited playlists</span>
                </div>
                <div class="feature-item">
                  <i class="bi bi-check-circle-fill text-success"></i>
                  <span>Advanced genre filtering</span>
                </div>
                <div class="feature-item">
                  <i class="bi bi-check-circle-fill text-success"></i>
                  <span>CSV export of all tracks</span>
                </div>
                <div class="feature-item">
                  <i class="bi bi-check-circle-fill text-success"></i>
                  <span>Priority customer support</span>
                </div>
                <div class="feature-item">
                  <i class="bi bi-check-circle-fill text-success"></i>
                  <span>Cancel anytime</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-lg-6">
            <div class="subscription-action">
              {% if current_user.is_authenticated %}
                {% if current_user.has_active_subscription %}
                  <div class="active-subscription">
                    <div class="alert alert-success mb-4">
                      <i class="bi bi-patch-check-fill me-2"></i>
                      <strong>Active Subscription</strong>
                      <p class="mb-0 mt-2">Your subscription is active. You have full access to all premium features.</p>
                    </div>
                    
                    {% if current_user.subscription_ends_at %}
                      <p class="text-muted mb-4">
                        Your subscription will {% if current_user.subscription_will_renew %}renew{% else %}expire{% endif %} on {{ current_user.subscription_ends_at.strftime('%B %d, %Y') }}.
                      </p>
                    {% endif %}
                    
                    <form action="{{ url_for('subscription.cancel') }}" method="POST" id="cancel-form">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#cancelModal">
                        <i class="bi bi-x-circle me-2"></i> Cancel Subscription
                      </button>
                    </form>
                  </div>
                {% else %}
                  <div class="card shadow-sm">
                    <div class="card-body p-4">
                      <h3 class="card-title h4 mb-3">Subscribe Now</h3>
                      <p class="card-text mb-4">Unlock all premium features for just $3 per month. Cancel anytime.</p>
                      
                      <button id="checkout-button" class="btn btn-primary btn-lg w-100">
                        <i class="bi bi-lock-fill me-2"></i> Subscribe Now
                      </button>
                      
                      <div class="text-center mt-3">
                        <small class="text-muted">Secure payment powered by Stripe</small>
                      </div>
                      
                      <div class="payment-methods mt-3">
                        <img src="https://cdn.jsdelivr.net/gh/creativetimofficial/public-assets@master/soft-ui-design-system-pro/assets/img/logos/visa.png" class="payment-icon" alt="Visa">
                        <img src="https://cdn.jsdelivr.net/gh/creativetimofficial/public-assets@master/soft-ui-design-system-pro/assets/img/logos/mastercard.png" class="payment-icon" alt="Mastercard">
                        <img src="https://cdn.jsdelivr.net/gh/creativetimofficial/public-assets@master/soft-ui-design-system-pro/assets/img/logos/amex.png" class="payment-icon" alt="American Express">
                      </div>
                    </div>
                  </div>
                {% endif %}
                
                {% if current_user.has_active_subscription %}
                  <div class="mt-4 text-center">
                    <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-primary">
                      <i class="bi bi-speedometer2 me-2"></i> Go to Dashboard
                    </a>
                  </div>
                {% endif %}
              {% else %}
                <div class="alert alert-warning">
                  <p class="mb-0"><i class="bi bi-info-circle-fill me-2"></i> Please <a href="{{ url_for('auth.login') }}">login</a> or <a href="{{ url_for('auth.register') }}">register</a> to subscribe.</p>
                </div>
              {% endif %}
              
              <div class="security-badges">
                <div class="security-badge">
                  <i class="bi bi-shield-lock-fill"></i>
                  <span>Secure Payment</span>
                </div>
                <div class="security-badge">
                  <i class="bi bi-credit-card-fill"></i>
                  <span>SSL Encrypted</span>
                </div>
                <div class="security-badge">
                  <i class="bi bi-calendar-check-fill"></i>
                  <span>Cancel Anytime</span>
                </div>
              </div>
            </div>
            
            <div class="legal-links">
              <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Terms of Service</a>
              <a href="#" data-bs-toggle="modal" data-bs-target="#privacyModal">Privacy Policy</a>
            </div>
          </div>
        </div>
        
        <div class="mt-4 text-center">
          <a href="{{ url_for('dashboard') if current_user.is_authenticated else url_for('index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i> Back
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Terms of Service Modal -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="termsModalLabel">Terms of Service</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h4>1. Acceptance of Terms</h4>
        <p>By accessing and using the Spotify Playlist Generator service, you agree to be bound by these Terms of Service. If you do not agree to these terms, please do not use our service.</p>
        
        <h4>2. Description of Service</h4>
        <p>Spotify Playlist Generator provides a service that creates playlists on Spotify based on data from YouTube and other sources. The service requires authentication with your Spotify account and a paid subscription.</p>
        
        <h4>3. Subscription and Billing</h4>
        <p>Our service requires a subscription fee of $3 per month. Payments are processed securely through Stripe. You may cancel your subscription at any time, and you will maintain access until the end of your current billing period.</p>
        
        <h4>4. Spotify Account</h4>
        <p>To use our service, you must connect your Spotify account. We will only perform actions that you explicitly authorize, such as creating playlists on your behalf.</p>
        
        <h4>5. Limitations</h4>
        <p>We do not guarantee that all YouTube tracks will be found on Spotify. Our matching algorithm does its best to find corresponding tracks, but some may not be available.</p>
        
        <h4>6. User Conduct</h4>
        <p>You agree not to use our service for any illegal purposes or in violation of Spotify's terms of service.</p>
        
        <h4>7. Modifications to Service</h4>
        <p>We reserve the right to modify or discontinue the service at any time without notice.</p>
        
        <h4>8. Privacy</h4>
        <p>Please refer to our Privacy Policy for information about how we collect, use, and disclose personal information.</p>
        
        <h4>9. Contact</h4>
        <p>If you have any questions about these Terms, please contact us at support@spotifyplaylistgenerator.com.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Privacy Policy Modal -->
<div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="privacyModalLabel">Privacy Policy</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h4>1. Information We Collect</h4>
        <p>We collect the following information:</p>
        <ul>
          <li>Email address and password for authentication</li>
          <li>Spotify account access tokens (with your permission)</li>
          <li>Payment information (processed securely through Stripe)</li>
          <li>Usage data such as playlists created and features used</li>
        </ul>
        
        <h4>2. How We Use Your Information</h4>
        <p>We use your information to:</p>
        <ul>
          <li>Provide and maintain our service</li>
          <li>Process payments</li>
          <li>Create playlists on Spotify on your behalf</li>
          <li>Improve our service</li>
          <li>Communicate with you</li>
        </ul>
        
        <h4>3. Data Security</h4>
        <p>We implement appropriate security measures to protect your personal information. We never store your Spotify password or full payment details.</p>
        
        <h4>4. Third-Party Services</h4>
        <p>We use the following third-party services:</p>
        <ul>
          <li>Spotify API for playlist creation</li>
          <li>Stripe for payment processing</li>
          <li>YouTube data for track information</li>
        </ul>
        
        <h4>5. Data Retention</h4>
        <p>We retain your data for as long as your account is active or as needed to provide you services. You may request deletion of your account at any time.</p>
        
        <h4>6. Your Rights</h4>
        <p>You have the right to:</p>
        <ul>
          <li>Access your personal data</li>
          <li>Correct inaccurate data</li>
          <li>Request deletion of your data</li>
          <li>Object to our processing of your data</li>
        </ul>
        
        <h4>7. Changes to This Policy</h4>
        <p>We may update our Privacy Policy from time to time. We will notify you of any changes by posting the new Privacy Policy on this page.</p>
        
        <h4>8. Contact Us</h4>
        <p>If you have questions about this Privacy Policy, please contact us at privacy@spotifyplaylistgenerator.com.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Create an instance of the Stripe object with your publishable API key
  var stripe = Stripe('{{ stripe_publishable_key }}');
  var checkoutButton = document.getElementById('checkout-button');

  if (checkoutButton) {
    checkoutButton.addEventListener('click', function() {
      // Show loading state
      checkoutButton.disabled = true;
      checkoutButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processing...';
      
      // Create a checkout session when the button is clicked
      fetch('{{ url_for("subscription.create_checkout_session") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token() }}'
        },
      })
      .then(function(response) {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(function(session) {
        return stripe.redirectToCheckout({ sessionId: session.id });
      })
      .then(function(result) {
        // If redirectToCheckout fails due to a browser or network
        // error, display the localized error message to your customer
        if (result.error) {
          alert(result.error.message);
          // Reset button state
          checkoutButton.disabled = false;
          checkoutButton.innerHTML = '<i class="bi bi-lock-fill me-2"></i> Subscribe Now';
        }
      })
      .catch(function(error) {
        console.error('Error:', error);
        alert('There was an error processing your payment. Please try again later.');
        // Reset button state
        checkoutButton.disabled = false;
        checkoutButton.innerHTML = '<i class="bi bi-lock-fill me-2"></i> Subscribe Now';
      });
    });
  }
</script>
{% endblock %}