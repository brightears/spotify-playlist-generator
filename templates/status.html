{% extends "base.html" %}

{% block title %}Playlist Status{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-[#1a1a1a] to-[#242831] py-12">
    <div class="max-w-4xl mx-auto px-4">
        <h1 class="text-3xl font-bold text-white mb-8">Playlist Generation Status</h1>
        
        <div class="bg-[#252525] rounded-xl border border-[#282828] shadow-xl p-8" id="status-box">
            <div id="loading-dimmer" class="text-center">
                <div class="inline-flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#00CFFF]"></div>
                    <span class="ml-3 text-[#b3b3b3]">Loading status...</span>
                </div>
            </div>
            
            <h2 class="text-2xl font-semibold text-white mb-4" id="status-header">Processing</h2>
            
            <div class="mb-4">
                <div class="w-full bg-[#1a1a1a] rounded-full h-3 mb-2" id="task-progress">
                    <div class="bg-[#00CFFF] h-3 rounded-full transition-all duration-300 bar" style="width: 0%"></div>
                </div>
                <p class="text-[#b3b3b3]" id="status-message">Initializing task...</p>
            </div>
        
            <div id="result-container" style="display: none;" class="mt-8">
                <div class="border-t border-[#282828] pt-6">
                    <h3 class="text-xl font-semibold text-white mb-4">Playlist Details</h3>
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex items-start space-x-3">
                            <svg class="w-6 h-6 text-[#00CFFF] mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                            </svg>
                            <div>
                                <div class="text-sm font-medium text-[#6a6a6a]">Name</div>
                                <div class="text-white" id="playlist-name"></div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <svg class="w-6 h-6 text-[#00CFFF] mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                            </svg>
                            <div>
                                <div class="text-sm font-medium text-[#6a6a6a]">Tracks</div>
                                <div class="text-white" id="track-count"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <h4 class="text-lg font-medium text-white mb-4">Export Options</h4>
                        <div class="flex flex-wrap gap-3">
                            <a class="inline-flex items-center justify-center px-6 py-3 bg-[#00CFFF] text-[#121212] rounded-full font-bold hover:bg-[#00a8d9] transition-all duration-200" id="csv-download-button" style="display: none;">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                </svg>
                                Download CSV
                            </a>
                            
                            <a class="inline-flex items-center justify-center px-6 py-3 border-2 border-[#00CFFF] text-[#00CFFF] rounded-full font-bold hover:bg-[#00CFFF] hover:text-[#121212] transition-all duration-200" id="m3u-download-button" style="display: none;">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Download M3U
                            </a>
                            
                            <a class="inline-flex items-center justify-center px-6 py-3 border-2 border-[#00CFFF] text-[#00CFFF] rounded-full font-bold hover:bg-[#00CFFF] hover:text-[#121212] transition-all duration-200" id="json-download-button" style="display: none;">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                                </svg>
                                Download JSON
                            </a>
                        </div>
                    </div>
                    
                    <div class="border-t border-[#282828] pt-6">
                        <h3 class="text-xl font-semibold text-white mb-4">Track Preview</h3>
                        <div class="space-y-3" id="track-list">
                            <!-- Track items will be inserted here -->
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <a href="{{ url_for('main.dashboard') }}" class="inline-flex items-center justify-center px-6 py-3 border border-[#282828] rounded-full text-white font-medium hover:bg-[#282828] transition-all duration-200">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        
            <div id="error-container" style="display: none;" class="mt-8">
                <div class="bg-red-900/20 border border-red-500 text-red-200 px-6 py-4 rounded-lg mb-6">
                    <h3 class="font-semibold mb-1">Error</h3>
                    <p id="error-message">There was a problem creating your playlist.</p>
                </div>
                
                <div class="flex gap-3">
                    <a href="{{ url_for('main.create', retry=task_id) }}" class="inline-flex items-center justify-center px-6 py-3 bg-[#00CFFF] text-[#121212] rounded-full font-bold hover:bg-[#00a8d9] transition-all duration-200">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Try Again
                    </a>
                    
                    <a href="{{ url_for('main.dashboard') }}" class="inline-flex items-center justify-center px-6 py-3 border border-[#282828] rounded-full text-white font-medium hover:bg-[#282828] transition-all duration-200">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Check if jQuery is available
console.log('jQuery available:', typeof $ !== 'undefined');
console.log('jQuery version:', typeof $ !== 'undefined' ? $.fn.jquery : 'Not available');

$(document).ready(function() {
    console.log('Document ready fired');
    const taskId = '{{ task_id }}';
    let pollInterval;
    let failedAttempts = 0;
    const maxFailedAttempts = 3;
    
    // Get CSRF token - use the one explicitly passed to the template
    const csrfToken = '{{ csrf_token }}';
    console.log('Task ID:', taskId);
    console.log('CSRF Token available:', csrfToken ? 'Yes' : 'No');
    
    // Set CSRF token for all AJAX requests
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)) {
                xhr.setRequestHeader("X-CSRFToken", csrfToken);
                console.log('Added CSRF token to request');
            }
        },
        xhrFields: {
            withCredentials: true  // This ensures cookies are sent with the request
        }
    });
    
    function updateStatus() {
        console.log('Polling for task status...');
        $.ajax({
            url: '/api/status/' + taskId,
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                console.log('Status update received:', data);
                // Reset failed attempts counter on success
                failedAttempts = 0;
                
                // Update progress bar (plain JavaScript since we don't have jQuery UI)
                const progressBar = document.querySelector('#task-progress .bar');
                if (progressBar) {
                    progressBar.style.width = data.progress + '%';
                }
                
                // Update status message
                $('#status-message').text(data.message);
                
                // Update header based on status
                if (data.status === 'complete') {
                    $('#status-header').text('Complete!').removeClass('text-yellow-400').addClass('text-green-400');
                    $('#loading-dimmer').hide();
                    
                    // Show results if available
                    if (data.result) {
                        showResults(data);
                    }
                    
                    // Stop polling
                    if (pollInterval) {
                        clearInterval(pollInterval);
                    }
                } else if (data.status === 'error') {
                    $('#status-header').text('Error').removeClass('text-yellow-400').addClass('text-red-400');
                    $('#status-message').text(data.error || 'An error occurred during playlist creation.');
                    $('#loading-dimmer').hide();
                    
                    // Stop polling
                    if (pollInterval) {
                        clearInterval(pollInterval);
                    }
                } else {
                    // Still processing
                    $('#status-header').text('Processing...').addClass('text-yellow-400');
                    $('#loading-dimmer').show();
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX error:', status, error);
                console.error('Response:', xhr.responseText);
                
                failedAttempts++;
                
                if (failedAttempts >= maxFailedAttempts) {
                    console.error('Max failed attempts reached, stopping polling');
                    $('#status-header').text('Connection Error').removeClass('processing').addClass('negative');
                    $('#status-message').text('Unable to connect to server. Please refresh the page.');
                    $('#loading-dimmer').removeClass('active');
                    
                    // Stop polling
                    if (pollInterval) {
                        clearInterval(pollInterval);
                    }
                } else {
                    console.log(`Failed attempt ${failedAttempts}/${maxFailedAttempts}, will retry...`);
                }
            }
        });
    }
    
    function showResults(data) {
        // Show result container
        $('#result-container').show();
        
        // Get the result object
        const result = data.result;
        
        // Fill in playlist details
        $('#playlist-name').text(result.playlist_name);
        $('#track-count').text(result.track_count + ' tracks');
        
        // Handle download buttons
        const csvButton = $('#csv-download-button');
        const m3uButton = $('#m3u-download-button');
        const jsonButton = $('#json-download-button');
        
        if (data.csv_data || result.tracks) {
            // Show all export options
            csvButton.attr('href', `/download/${taskId}?format=csv`);
            csvButton.show();
            
            m3uButton.attr('href', `/download/${taskId}?format=m3u`);
            m3uButton.show();
            
            jsonButton.attr('href', `/download/${taskId}?format=json`);
            jsonButton.show();
        }
        
        // Add additional info if available
        if (result.genre) {
            $('#result-container').append(`
                <div class="bg-blue-900/20 border border-blue-500 text-blue-200 px-6 py-4 rounded-lg mt-6">
                    <h4 class="font-semibold mb-2">Playlist Details</h4>
                    <p><strong>Genre:</strong> ${result.genre}</p>
                    <p><strong>Days Searched:</strong> ${result.days_searched}</p>
                    ${result.sources_used ? `<p><strong>Sources:</strong> ${result.sources_used.join(', ')}</p>` : ''}
                </div>
            `);
        }
        
        // Fill in track list
        const trackList = $('#track-list');
        trackList.empty();
        
        if (result.tracks && result.tracks.length > 0) {
            result.tracks.forEach(function(track, index) {
                // Generate search links for each platform
                const searchQuery = encodeURIComponent(`${track.artist} ${track.title}`);
                const spotifyUrl = `https://open.spotify.com/search/${searchQuery}`;
                const tidalUrl = `https://tidal.com/search?q=${searchQuery}`;
                const youtubeUrl = `https://music.youtube.com/search?q=${searchQuery}`;
                const beatportUrl = `https://www.beatport.com/search?q=${searchQuery}`;
                const traxsourceUrl = `https://www.traxsource.com/search?term=${searchQuery}`;
                
                const trackItem = $(`
                    <div class="p-4 rounded-lg bg-[#1a1a1a] hover:bg-[#282828] transition-colors">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="font-medium text-white">${track.title}</div>
                                <div class="text-sm text-[#6a6a6a] mb-3">
                                    ${track.artist}${track.remix ? ` (${track.remix})` : ''}
                                    ${track.source ? ` • via ${track.source}` : ''}
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <a href="${spotifyUrl}" target="_blank" class="inline-flex items-center px-3 py-1 bg-[#1DB954]/10 text-[#1DB954] rounded-full text-xs font-medium hover:bg-[#1DB954]/20 transition-colors">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                                        </svg>
                                        Spotify
                                    </a>
                                    <a href="${tidalUrl}" target="_blank" class="inline-flex items-center px-3 py-1 bg-[#00FFFF]/10 text-[#00FFFF] rounded-full text-xs font-medium hover:bg-[#00FFFF]/20 transition-colors">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 0C5.376 0 0 5.376 0 12s5.376 12 12 12 12-5.376 12-12S18.624 0 12 0zm-1.68 15.936v-3.84h3.36v3.84H12.32zm0-5.28V4.8h3.36v5.856H12.32z"/>
                                        </svg>
                                        Tidal
                                    </a>
                                    <a href="${youtubeUrl}" target="_blank" class="inline-flex items-center px-3 py-1 bg-[#FF0000]/10 text-[#FF0000] rounded-full text-xs font-medium hover:bg-[#FF0000]/20 transition-colors">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                                        </svg>
                                        YouTube
                                    </a>
                                    <a href="${beatportUrl}" target="_blank" class="inline-flex items-center px-3 py-1 bg-[#94D500]/10 text-[#94D500] rounded-full text-xs font-medium hover:bg-[#94D500]/20 transition-colors">
                                        Beatport
                                    </a>
                                    <a href="${traxsourceUrl}" target="_blank" class="inline-flex items-center px-3 py-1 bg-[#FF6600]/10 text-[#FF6600] rounded-full text-xs font-medium hover:bg-[#FF6600]/20 transition-colors">
                                        Traxsource
                                    </a>
                                </div>
                            </div>
                            <span class="text-[#6a6a6a] text-sm ml-4">#${index + 1}</span>
                        </div>
                    </div>
                `);
                trackList.append(trackItem);
            });
        } else {
            trackList.append('<div class="text-[#6a6a6a]">No tracks available</div>');
        }
    }
    
    // Initial status check
    updateStatus();
    
    // Poll for updates every 3 seconds (increased from 2 to reduce server load)
    pollInterval = setInterval(updateStatus, 3000);
    
    // Clean up the interval when leaving the page
    $(window).on('beforeunload', function() {
        if (pollInterval) {
            clearInterval(pollInterval);
        }
    });
});
</script>
{% endblock %}