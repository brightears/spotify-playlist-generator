{% extends "base.html" %}

{% block title %}Playlist Status - Spotify Playlist Generator{% endblock %}

{% block head %}
<meta id="task-id" data-task-id="{{ task_id }}">
<meta id="playlist-id" data-playlist-id="{{ playlist_id }}">
<style>
    .progress-container {
        margin-bottom: 30px;
    }
    .error-box {
        margin-top: 20px;
    }
    .log-container {
        max-height: 400px;
        overflow-y: auto;
        background-color: #f8f9fa;
        border-radius: 4px;
        padding: 15px;
        font-family: monospace;
        font-size: 0.9rem;
    }
    .log-entry {
        margin-bottom: 5px;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
    }
    .log-entry:last-child {
        border-bottom: none;
    }
    .log-entry.error {
        color: #dc3545;
    }
    .log-entry.warning {
        color: #ffc107;
    }
    .log-entry.success {
        color: #198754;
    }
    .timestamp {
        color: #6c757d;
        margin-right: 10px;
    }
    #progress-bar {
        height: 25px;
    }
    .result-table th {
        position: sticky;
        top: 0;
        background-color: #fff;
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
{% if error %}
<div class="alert alert-danger" role="alert">
    <h4 class="alert-heading">Error!</h4>
    <p>{{ error }}</p>
    <hr>
    <p class="mb-0">
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-danger">
            <i class="fas fa-arrow-left"></i> Back to Form
        </a>
    </p>
</div>
{% else %}
<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h2 class="h4 mb-0">Playlist Creation Status</h2>
                <span id="status-badge" class="badge bg-secondary">Initializing...</span>
            </div>
            <div class="card-body">
                <div class="progress-container">
                    <div class="progress" style="height: 25px;">
                        <div id="progress-bar" 
                             class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100" 
                             style="width: 0%">
                            0%
                        </div>
                    </div>
                    <p id="status-message" class="text-center mt-2">Starting playlist creation...</p>
                </div>
                
                <div id="results-container" style="display: none;">
                    <h3 class="h5 mb-3">Results</h3>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover result-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Track</th>
                                    <th>Artist</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="results-table-body">
                                <!-- Results will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-body p-3">
                                        <h5 class="card-title h6">Statistics</h5>
                                        <ul class="list-unstyled mb-0">
                                            <li><span class="fw-bold">Total tracks:</span> <span id="stat-total">-</span></li>
                                            <li><span class="fw-bold">Matched:</span> <span id="stat-matched">-</span></li>
                                            <li><span class="fw-bold">Not found:</span> <span id="stat-not-found">-</span></li>
                                            <li><span class="fw-bold">Filtered:</span> <span id="stat-filtered">-</span></li>
                                            <li><span class="fw-bold">Match rate:</span> <span id="stat-match-rate">-</span></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-body p-3">
                                        <h5 class="card-title h6">Playlist Information</h5>
                                        <ul class="list-unstyled mb-0">
                                            <li><span class="fw-bold">Name:</span> <span id="playlist-name">-</span></li>
                                            <li><span class="fw-bold">Tracks added:</span> <span id="playlist-tracks">-</span></li>
                                            <li>
                                                <span class="fw-bold">Spotify link:</span> 
                                                <a id="playlist-link" href="#" target="_blank" style="display: none;">
                                                    Open in Spotify <i class="fas fa-external-link-alt"></i>
                                                </a>
                                                <span id="playlist-link-placeholder">-</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 d-flex gap-2 flex-wrap">
                        <a id="download-csv" href="{{ url_for('playlist.download_csv', task_id=task_id) }}" class="btn btn-outline-primary" style="display: none;">
                            <i class="fas fa-download me-2"></i> Download CSV
                        </a>
                        <a id="view-playlist-btn" href="#" target="_blank" class="btn btn-success" style="display: none;">
                            <i class="fab fa-spotify me-2"></i> View on Spotify
                        </a>
                        <button id="show-logs-btn" class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#logsCollapse">
                            <i class="fas fa-terminal me-2"></i> Show Logs
                        </button>
                    </div>
                    
                    <div class="collapse mt-4" id="logsCollapse">
                        <h3 class="h5 mb-2">Process Logs</h3>
                        <div id="log-container" class="log-container">
                            <!-- Logs will be populated here -->
                        </div>
                    </div>
                </div>
                
                <div id="error-container" class="error-box alert alert-danger" style="display: none;">
                    <h4 class="alert-heading">Error Occurred</h4>
                    <p id="error-message"></p>
                    <div id="error-details" class="mt-3"></div>
                </div>
                
                <div class="mt-3 text-center">
                    <a href="{{ url_for('main.index') }}" class="btn btn-primary">
                        <i class="fas fa-home me-2"></i> Back to Home
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        const taskId = $('#task-id').data('task-id');
        const playlistId = $('#playlist-id').data('playlist-id');
        let pollInterval;
        let isComplete = false;
        let stats = {
            total: 0,
            matched: 0,
            notFound: 0,
            filtered: 0
        };
        
        // Initial check
        checkStatus();
        
        // Set up polling every 2 seconds
        pollInterval = setInterval(checkStatus, 2000);
        
        function checkStatus() {
            if (isComplete) {
                clearInterval(pollInterval);
                return;
            }
            
            $.ajax({
                url: "{{ url_for('playlist.api_task_status', task_id='') }}" + taskId,
                type: 'GET',
                success: function(data) {
                    updateUI(data);
                    
                    if (data.state === 'SUCCESS' || data.state === 'FAILURE') {
                        clearInterval(pollInterval);
                        isComplete = true;
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error fetching status:", error);
                    $('#error-container').show();
                    $('#error-message').text("Failed to fetch task status: " + error);
                }
            });
        }
        
        function updateUI(data) {
            // Update status badge
            let badgeClass = 'bg-secondary';
            let statusText = 'Unknown';
            
            switch(data.state) {
                case 'PENDING':
                    badgeClass = 'bg-secondary';
                    statusText = 'Pending';
                    break;
                case 'STARTED':
                    badgeClass = 'bg-info';
                    statusText = 'In Progress';
                    break;
                case 'SUCCESS':
                    badgeClass = 'bg-success';
                    statusText = 'Completed';
                    break;
                case 'FAILURE':
                    badgeClass = 'bg-danger';
                    statusText = 'Failed';
                    break;
            }
            
            $('#status-badge').removeClass().addClass('badge ' + badgeClass).text(statusText);
            
            // Update progress
            if (data.info && data.info.progress !== undefined) {
                const progress = data.info.progress;
                $('#progress-bar').css('width', progress + '%').attr('aria-valuenow', progress).text(progress + '%');
                
                if (data.info.status_message) {
                    $('#status-message').text(data.info.status_message);
                }
            }
            
            // Handle results when complete
            if (data.state === 'SUCCESS' && data.result) {
                displayResults(data.result);
            }
            
            // Handle failure
            if (data.state === 'FAILURE') {
                $('#error-container').show();
                $('#error-message').text(data.error || "An unknown error occurred");
                if (data.traceback) {
                    $('#error-details').html('<pre>' + data.traceback + '</pre>');
                }
            }
            
            // Update logs if available
            if (data.info && data.info.logs) {
                updateLogs(data.info.logs);
            }
        }
        
        function displayResults(result) {
            $('#results-container').show();
            
            // Clear previous results
            $('#results-table-body').empty();
            
            // Display track results
            if (result.tracks) {
                stats = {
                    total: result.tracks.length,
                    matched: 0,
                    notFound: 0,
                    filtered: 0
                };
                
                result.tracks.forEach((track, index) => {
                    let statusIcon = '';
                    let statusText = '';
                    let rowClass = '';
                    
                    if (track.status === 'matched') {
                        statusIcon = '<i class="fas fa-check text-success"></i>';
                        statusText = 'Matched';
                        stats.matched++;
                    } else if (track.status === 'filtered') {
                        statusIcon = '<i class="fas fa-filter text-warning"></i>';
                        statusText = 'Filtered: ' + track.filter_reason;
                        rowClass = 'table-warning';
                        stats.filtered++;
                    } else {
                        statusIcon = '<i class="fas fa-times text-danger"></i>';
                        statusText = 'Not Found';
                        rowClass = 'table-danger';
                        stats.notFound++;
                    }
                    
                    const row = `
                        <tr class="${rowClass}">
                            <td>${index + 1}</td>
                            <td>${track.title}</td>
                            <td>${track.artist}</td>
                            <td>${statusIcon} ${statusText}</td>
                        </tr>
                    `;
                    
                    $('#results-table-body').append(row);
                });
                
                // Update statistics
                $('#stat-total').text(stats.total);
                $('#stat-matched').text(stats.matched);
                $('#stat-not-found').text(stats.notFound);
                $('#stat-filtered').text(stats.filtered);
                
                const matchRate = stats.total > 0 ? Math.round((stats.matched / stats.total) * 100) : 0;
                $('#stat-match-rate').text(matchRate + '%');
            }
            
            // Update playlist info
            if (result.playlist) {
                $('#playlist-name').text(result.playlist.name || '-');
                $('#playlist-tracks').text(stats.matched);
                
                if (result.playlist.url) {
                    $('#playlist-link').attr('href', result.playlist.url).show();
                    $('#playlist-link-placeholder').hide();
                    $('#view-playlist-btn').attr('href', result.playlist.url).show();
                }
            }
            
            // Show download button
            $('#download-csv').show();
        }
        
        function updateLogs(logs) {
            const logContainer = $('#log-container');
            logContainer.empty();
            
            logs.forEach(log => {
                let logClass = '';
                if (log.level === 'ERROR') logClass = 'error';
                if (log.level === 'WARNING') logClass = 'warning';
                if (log.level === 'SUCCESS') logClass = 'success';
                
                const logEntry = `
                    <div class="log-entry ${logClass}">
                        <span class="timestamp">[${log.timestamp}]</span>
                        <span class="message">${log.message}</span>
                    </div>
                `;
                
                logContainer.append(logEntry);
            });
            
            // Scroll to bottom
            logContainer.scrollTop(logContainer[0].scrollHeight);
        }
    });
</script>
{% endblock %}
